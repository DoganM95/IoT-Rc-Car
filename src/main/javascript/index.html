<!DOCTYPE html>
<html>
  <head>
    <link rel="manifest" href="manifest.json" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/101/three.min.js"></script>
    <!-- include socket.io client side script -->
  </head>

  <body>
    <div id="sensors">
      <h3 id="gamma">InitialGamma</h3>
      <br />
      <h3 id="beta">InitialBeta</h3>
      <br />
      <h3 id="alpha">InitialAlpha</h3>
      <br />
      <h3 id="absolute">
        InitialAbsolute
      </h3>
    </div>
    <br /><br />
    <div id="data">
      <p>Motor Speed by orientation:</p>
      <p id="motor-speed-orientation"></p>
      <p>Motor Speed in km/h:</p>
      <p id="motor-speed-kmh"></p>
      <p>Motor Direction:</p>
      <p id="motor-direction"></p>
      <br />
      <p>Steering Angle by orientation:</p>
      <p id="steering-angle-orientation"></p>
      <p>Steering Angle by degrees:</p>
      <p id="steering-angle-degrees"></p>
      <p>Steering Requests per Second:</p>
      <p id="steering-angle"></p>
    </div>

    <script>
      //---------------------------------------------------------------------
      //Global Vars
      //---------------------------------------------------------------------
      //CONNECTION
      var socket = io(); //load socket.io-client and connect to the host that serves the page

      //VARS
      let semaphore = {
        speed: {
          free: true
        },
        steering: {
          free: true
        }
      };

      let axisLimits = {
        left: -30,
        right: 30,
        top: 55,
        bottom: -55,
        deadzone: {
          left: 0,
          right: 0,
          top: 5,
          bottom: -5
        }
      };

      let car = {
        engine: {
          speed: {
            value: 0, //Stop motor initially
            increment: 5
          }
        },
        steering: {
          angle: {
            value: 1500, //Center position initially
            increment: 10
          },
          invert: true
        }
      };

      //---------------------------------------------------------------------
      // MAIN
      //---------------------------------------------------------------------

      socket.emit("steeringSocket", car.steering.angle.value); //initially center servo
      socket.emit("axisLimits", axisLimits);

      window.addEventListener("load", function() {
        //DOM
        const alpha = document.getElementById("alpha");
        const beta = document.getElementById("beta");
        const gamma = document.getElementById("gamma");
        const absolute = document.getElementById("absolute");
        let motor = document.getElementById("motorState");
        let servoLeftElement = document.getElementById("servoLeftButton");
        let servoRightElement = document.getElementById("servoRightButton");

        socket.on("motorSpeedSocket", data => {
          //when motor-speed changes, receive the speed via socket
          car.engine.speed.value = data; //set car.engine.speed.value's value to the current speed
          console.log("received current car.engine.speed.value via socket: " + car.engine.speed.value);
        });

        socket.on("servoAngleSocket", data => {
          car.steering.angle.value = data;
          console.log("received current car.steering.angle.value via Socket: " + car.steering.angle.value);
        });

        document.addEventListener("keydown", key => {
          console.log("Key: " + key.keyCode + " pressed."); //log the pressed key
          switch (
            key.keyCode //switch statement for pressed key
          ) {
            case 40: //backwards
              if (car.engine.speed.value > 0) {
                (async () => {
                  socket.emit("motorSocket", car.engine.speed.value - car.engine.speed.increment);
                })(); //increase car.engine.speed.value by car.engine.speed.increment's value
              }
              break;
            case 38: //forwards
              if (car.engine.speed.value < 255) {
                (async () => {
                  socket.emit("motorSocket", car.engine.speed.value + car.engine.speed.increment);
                })(); //decrease car.engine.speed.value by car.engine.speed.increment's value
              }
              break;
            case 53: //Full Speed or stop (like play pause)
              if (car.engine.speed.value > 0) {
                socket.emit("motorSocket", 0); //stops motor, if motor is running
              }
              if (car.engine.speed.value == 0) {
                socket.emit("motorSocket", 255); //max-speeds motor, if it was off
              }
              break;
            //Servo direction control
            case 39: //key right
              if (car.steering.angle.value > 500) {
                (async () => {
                  socket.emit("steeringSocket", car.steering.angle.value - car.steering.angle.increment);
                  car.steering.angle.value -= car.steering.angle.increment;
                })();
              }
              break;
            case 37: //key left
              if (car.steering.angle.value < 2500) {
                (async () => {
                  socket.emit("steeringSocket", car.steering.angle.value + car.steering.angle.increment);
                  car.steering.angle.value += car.steering.angle.increment;
                })();
              }
              break;
          }
        });

        window.addEventListener("deviceorientation", handleOrientation, true); //reads axis information from device this html page is running on
      });

      //---------------------------------------------------------------------
      // FUNCTIONS
      //---------------------------------------------------------------------

      function handleOrientation(event) {
        //        55            gamma
        // -30    +-5    30     betas  //gamma dead zone = 5 (the zone where nothing happens) for speed only, as unwanted steering is not critical
        //       -55            gamma

        roundAxisValue("speed", event.gamma, 50);
        roundAxisValue("steering", event.beta, 50);

        //Manipulate DOM to show values on html page
        gamma.innerHTML = "Gamma: " + event.gamma;
        beta.innerHTML = "Beta: " + event.beta;
        alpha.innerHTML = "Alpha: " + event.alpha;
        absolute.innerHTML = "Absolute: " + event.absolute;
      }

      async function roundAxisValue(property, axisValue, timeout) {
        try {
          if (property == "speed") {
            if (semaphore.speed.free) {
              semaphore.speed.free = false;
              socket.emit("engineSocket", {
                angle: axisValue
              });
              semaphore.speed.free = true;
            } else {
              return;
            }
          }

          //beta (steering) is between -30 and 30 in axis
          //servo angle can be between 500 (== 90°(deg)) and 2500 (== -90°(deg))
          else if (property == "steering") {
            //in case function gets steering param
            if (semaphore.steering.free) {
              semaphore.steering.free = false;
              let steering = Math.round(axisValue);
              if (0 <= steering < 30) {
                socket.emit(
                  "steeringSocket",
                  car.steering.invert ? 1500 + Math.abs(steering) * 33 : 1500 - Math.abs(steering) * 33
                ); //goes to max 2490, rest is handled by overtilt right to 2500
              } else if (-30 < steering <= 0) {
                socket.emit(
                  "steeringSocket",
                  car.steering.invert ? 1500 - Math.abs(steering) * 33 : 1500 + Math.abs(steering) * 33
                ); //goes to min 210, rest is handled by overtilt left to 500
              } else if (steering <= -30) {
                socket.emit("steeringSocket", 2500);
              } else if (steering >= 30) {
                socket.emit("steeringSocket", 500);
              } else {
                return;
              }
              semaphore.steering.free = true;
              return;
            }
          } else {
            throw new Error("roundAxisValue() can only take 'speed' or 'steering'. You typed " + property);
          }
        } catch (err) {
          console.log(err);
        }
        return;
      }
    </script>
  </body>
</html>
