<!DOCTYPE html>
<html>

<head>
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/101/three.min.js"></script>
  <!-- include socket.io client side script -->
</head>

<body>
  <div id="sensors">
    <h3 id="gamma">Gamma</h3><br />
    <h3 id="beta">Beta</h3><br />
    <h3 id="alpha">Alpha</h3><br />
    <h3 id="absolute">Absolute</h3>
  </div>
  <br /><br />
  <div id="data">
    <p>Motor Speed by orientation:</p>
    <p id="motor-speed-orientation"></p>
    <p>Motor Speed in km/h:</p>
    <p id="motor-speed-kmh"></p>
    <p>Motor Direction:</p>
    <p id="motor-direction"></p>
    <br />
    <p>Steering Angle by orientation:</p>
    <p id="steering-angle-orientation"></p>
    <p>Steering Angle by degrees:</p>
    <p id="steering-angle-degrees"></p>
    <p>Steering Requests per Second:</p>
    <p id="steering-angle"></p>
  </div>


  <script type="text/javascript" src="./controls/keypad.js">
    import keypadHandler from "/controls/keypad.js";
    document.addEventListener("keydown", keypadHandler);
  </script>


  <script>
    //---------------------------------------------------------------------
    //Global Vars
    //---------------------------------------------------------------------
    //CONNECTION
    var socket = io(); //load socket.io-client and connect to the host that serves the page

    //VARS
    let semaphore = {
      speed: {
        free: true
      },
      steering: {
        free: true
      },
      key: {
        left: true,
        right: true,
        up: true,
        down: true
      }
    };

    let thisClient = {
      settings: {
        axisLimits: {
          left: -30,
          right: 30,
          top: 55,
          bottom: -55,
          deadzone: {
            left: 0,
            right: 0,
            top: 5,
            bottom: -5
          }
        }
      },
      car: {
        engine: {
          speed: {
            value: 0, //Stop motor initially
            increment: 5
          }
        },
        steering: {
          angle: {
            value: 1500, //Center position initially
            increment: 10
          },
          invert: true
        }
      }
    };

    //---------------------------------------------------------------------
    // MAIN
    //---------------------------------------------------------------------

    window.addEventListener("load", function () {
      const alpha = document.getElementById("alpha");
      const beta = document.getElementById("beta");
      const gamma = document.getElementById("gamma");
      const absolute = document.getElementById("absolute");
      let motor = document.getElementById("motorState");
      let servoLeftElement = document.getElementById("servoLeftButton");
      let servoRightElement = document.getElementById("servoRightButton");

      //Socket Emissions
      socket.emit("steeringSocket", thisClient.car.steering.angle.value); //initially center servo
      socket.emit("axisLimits", thisClient.settings.axisLimits);

      //Socket Receives
      socket.on("motorSpeedSocket", data => {
        //when motor-speed changes, receive the speed via socket
        thisClient.car.engine.speed.value =
          data; //set thisClient.car.engine.speed.value's value to the current speed
        console.log(
          "received current thisClient.car.engine.speed.value via socket: " + thisClient.car.engine.speed
          .value
        );
      });

      socket.on("servoAngleSocket", data => {
        thisClient.car.steering.angle.value = data;
        console.log(
          "received current thisClient.car.steering.angle.value via Socket: " + thisClient.car.steering.angle
          .value
        );
      });



      function handleOrientationEvent(event) {
        //        55            gamma
        // -30    +-5    30     betas  //gamma dead zone = 5 (the zone where nothing happens) for speed only, as unwanted steering is not critical
        //       -55            gamma

        roundAxisValue("speed", event.gamma, 50);
        roundAxisValue("steering", event.beta ? event.beta : event.y * 90, 50);

        //Manipulate DOM to show values on html page
        gamma.innerHTML = "Gamma: " + event.gamma;
        beta.innerHTML = "Beta: " + event.beta;
        alpha.innerHTML = "Alpha: " + event.alpha;
        absolute.innerHTML = "Absolute: " + event.absolute;
      }

      window.addEventListener(
        "deviceorientation", handleOrientationEvent, true);
    });

    //---------------------------------------------------------------------
    // FUNCTIONS
    //---------------------------------------------------------------------

    async function roundAxisValue(property, axisValue, timeout) {
      try {
        if (property == "speed") {
          if (semaphore.speed.free) {
            semaphore.speed.free = false;
            socket.emit("engineSocket", {
              angle: axisValue
            });
            semaphore.speed.free = true;
          } else {
            return;
          }
        }

        //servo angle can be between 500 (== 90°(deg)) and 2500 (== -90°(deg))
        else if (property == "steering") {
          //in case function gets steering param
          if (semaphore.steering.free) {
            semaphore.steering.free = false;
            let steering = Math.round(axisValue);
            if (0 <= steering < 30) {
              socket.emit(
                "steeringSocket",
                thisClient.car.steering.invert ? 1500 + Math.abs(steering) * 33 : 1500 - Math.abs(steering) * 33
              ); //goes to max 2490, rest is handled by overtilt right to 2500
            } else if (-30 < steering <= 0) {
              socket.emit(
                "steeringSocket",
                thisClient.car.steering.invert ? 1500 - Math.abs(steering) * 33 : 1500 + Math.abs(steering) * 33
              ); //goes to min 210, rest is handled by overtilt left to 500
            } else if (steering <= -30) {
              socket.emit("steeringSocket", 2500);
            } else if (steering >= 30) {
              socket.emit("steeringSocket", 500);
            } else {
              return;
            }
            semaphore.steering.free = true;
            return;
          }
        } else {
          throw new Error("roundAxisValue() can only take 'speed' or 'steering'. You typed " + property);
        }
      } catch (err) {
        console.log(err);
      }
      return;
    }
  </script>
</body>

</html>